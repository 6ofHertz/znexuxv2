# ğŸ”¥ ZURVAN + Firestore: Complete Data Flow Guide

## ğŸ“Š Your Firestore Database Schema

### **Production Rules Status**
- âœ… **Security Mode:** Production (no expiration)
- âœ… **Authentication:** Required for all operations
- âœ… **Data Isolation:** Users can only access their own data
- âœ… **Validation:** Automatic `user_id` verification

---

## ğŸ—‚ï¸ Collections & Schema

### 1. **`tasks`** Collection

**Purpose:** Store user tasks with completion tracking

```typescript
{
  id: string;                    // Auto-generated by Firestore
  user_id: string;               // Firebase Auth UID (required)
  title: string;                 // Task name
  description?: string;          // Optional details
  completed: boolean;            // Completion status
  estimatedMinutes: number;      // Time estimate
  stream?: string;               // Associated learning stream
  priority: 'low' | 'medium' | 'high';  // Priority level
  created_at: Timestamp;         // Auto-generated
  updated_at: Timestamp;         // Auto-updated
}
```

**Example Document:**
```json
{
  "id": "task_abc123",
  "user_id": "firebase_uid_xyz",
  "title": "Complete React hooks tutorial",
  "description": "Learn useState, useEffect, useContext",
  "completed": false,
  "estimatedMinutes": 90,
  "stream": "Frontend Development",
  "priority": "high",
  "created_at": "2025-01-15T10:30:00Z",
  "updated_at": "2025-01-15T10:30:00Z"
}
```

---

### 2. **`streams`** Collection

**Purpose:** Track learning streams and progress

```typescript
{
  id: string;                    // Auto-generated
  user_id: string;               // Firebase Auth UID (required)
  name: string;                  // Stream name
  description?: string;          // Optional description
  progress: number;              // 0-100 percentage
  color?: string;                // Theme color (hex)
  icon?: string;                 // Icon identifier
  tasksRemaining?: number;       // Number of pending tasks
  nextDeadline?: string;         // ISO date string
  created_at: Timestamp;         // Auto-generated
  updated_at: Timestamp;         // Auto-updated
}
```

**Example Document:**
```json
{
  "id": "stream_def456",
  "user_id": "firebase_uid_xyz",
  "name": "Frontend Development",
  "description": "Master React, TypeScript, and modern frontend",
  "progress": 45,
  "color": "#3b82f6",
  "icon": "code",
  "tasksRemaining": 5,
  "nextDeadline": "2025-01-20T00:00:00Z",
  "created_at": "2025-01-10T08:00:00Z",
  "updated_at": "2025-01-15T10:30:00Z"
}
```

---

### 3. **`focus_sessions`** Collection

**Purpose:** Track Pomodoro sessions and focus time (ready for future implementation)

```typescript
{
  id: string;                    // Auto-generated
  user_id: string;               // Firebase Auth UID (required)
  task_id?: string;              // Associated task
  duration_minutes: number;      // Session length
  started_at: Timestamp;         // Start time
  completed_at?: Timestamp;      // End time (null if interrupted)
  interruptions: number;         // Number of breaks
  notes?: string;                // Session notes
  created_at: Timestamp;         // Auto-generated
}
```

---

### 4. **`audit_logs`** Collection

**Purpose:** Track user actions for admin monitoring

```typescript
{
  id: string;                    // Auto-generated
  user_id: string;               // Firebase Auth UID (required)
  action: string;                // Action type (login, task_update, etc.)
  metadata: object;              // Additional context
  ip_address?: string;           // User IP (optional)
  created_at: Timestamp;         // Auto-generated
}
```

**Example Document:**
```json
{
  "id": "log_ghi789",
  "user_id": "firebase_uid_xyz",
  "action": "task_update",
  "metadata": {
    "taskId": "task_abc123",
    "completed": true
  },
  "created_at": "2025-01-15T10:35:00Z"
}
```

---

## ğŸ”„ Data Flow: How Data Moves Through ZURVAN

### **Step 1: User Authentication** ğŸ”

```
User Signs In
     â†“
Firebase Auth creates session
     â†“
AuthContext stores user object
     â†“
user.uid becomes the user_id for all data
```

### **Step 2: Loading Data** ğŸ“¥

```
Index.tsx (Main Page)
     â†“
useEffect triggers on mount
     â†“
getTasks(user.uid) + getStreams(user.uid)
     â†“
Firestore query: where('user_id', '==', user.uid)
     â†“
Returns only user's data (security enforced)
     â†“
Sets state: setTasks() + setStreams()
     â†“
UI renders with user's tasks/streams
```

**Code Example (from Index.tsx):**
```typescript
useEffect(() => {
  const fetchData = async () => {
    if (!user) return;

    try {
      setDataLoading(true);
      
      const [tasksData, streamsData] = await Promise.all([
        getTasks(user.uid),      // Fetch user's tasks
        getStreams(user.uid)     // Fetch user's streams
      ]);

      setTasks(tasksData);
      setStreams(streamsData);
    } catch (error) {
      toast.error('Failed to load data');
    } finally {
      setDataLoading(false);
    }
  };

  fetchData();
}, [user]);
```

### **Step 3: Creating Data** â•

```
User interacts with UI (e.g., creates a task)
     â†“
Component calls createTask() function
     â†“
src/lib/firebase/firestore.ts
     â†“
Adds document to Firestore with user_id
     â†“
Firestore validates: user_id === auth.uid âœ…
     â†“
Document saved to 'tasks' collection
     â†“
Returns new task with auto-generated ID
     â†“
UI updates with new data
```

**Code Example:**
```typescript
import { createTask } from '@/lib/firebase/firestore';
import { useAuth } from '@/contexts/AuthContext';

const handleCreateTask = async () => {
  const newTask = await createTask(user.uid, {
    title: "Learn TypeScript",
    description: "Complete official handbook",
    completed: false,
    estimatedMinutes: 120,
    stream: "Frontend Development",
    priority: "high"
  });
  
  // Update local state
  setTasks([newTask, ...tasks]);
  toast.success('Task created!');
};
```

### **Step 4: Updating Data** ğŸ”„

```
User toggles task completion
     â†“
handleToggleTask(taskId) called
     â†“
updateTask(taskId, { completed: !task.completed })
     â†“
Firestore validates ownership
     â†“
Document updated with new completed status
     â†“
Local state updated
     â†“
Audit log created
     â†“
UI reflects change
```

**Code Example (from Index.tsx):**
```typescript
const handleToggleTask = async (taskId: string) => {
  const task = tasks.find(t => t.id === taskId);
  if (!task || !user) return;

  try {
    // Update in Firestore
    await updateTask(taskId, { completed: !task.completed });

    // Update local state
    setTasks(tasks.map(t => 
      t.id === taskId ? { ...t, completed: !t.completed } : t
    ));
    
    toast.success(task.completed ? 'Task reopened' : 'Task completed!');
    
    // Log the action
    await logAudit({
      userId: user.uid,
      action: 'task_update',
      metadata: { taskId, completed: !task.completed }
    });
  } catch (error) {
    toast.error('Failed to update task');
  }
};
```

---

## ğŸ¯ How to Input Data via ZURVAN

### **Method 1: Via UI Components** (Recommended when UI is built)

When you have task creation UI:

```typescript
// In a TaskForm component
import { createTask } from '@/lib/firebase/firestore';
import { useAuth } from '@/contexts/AuthContext';

const TaskForm = () => {
  const { user } = useAuth();
  
  const handleSubmit = async (formData) => {
    const newTask = await createTask(user.uid, {
      title: formData.title,
      description: formData.description,
      completed: false,
      estimatedMinutes: formData.estimatedMinutes,
      stream: formData.stream,
      priority: formData.priority
    });
    
    // Success!
  };
};
```

### **Method 2: Via Firebase Console** (For testing/initial data)

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Select project: **znexux-954bd**
3. Navigate to **Firestore Database**
4. Click **"Start collection"**
5. Collection ID: `tasks`
6. Add document with these fields:

```
Document ID: (auto-generated)
Fields:
  user_id: (string) "YOUR_FIREBASE_AUTH_UID"
  title: (string) "Complete React tutorial"
  description: (string) "Learn hooks and context"
  completed: (boolean) false
  estimatedMinutes: (number) 90
  stream: (string) "Frontend Development"
  priority: (string) "high"
  created_at: (timestamp) (use Firebase timestamp picker)
  updated_at: (timestamp) (use Firebase timestamp picker)
```

### **Method 3: Via Browser Console** (For quick testing)

1. Open ZURVAN in browser
2. Sign in to get `user.uid`
3. Open browser console (F12)
4. Paste this code:

```javascript
// Get the Firebase functions
const { createTask } = await import('/src/lib/firebase/firestore.ts');
const { user } = await import('/src/contexts/AuthContext.tsx');

// Create a test task
await createTask(user.uid, {
  title: "Test task from console",
  description: "Testing Firestore integration",
  completed: false,
  estimatedMinutes: 30,
  stream: "Testing",
  priority: "medium"
});

console.log('Task created! Refresh to see it.');
```

---

## ğŸ”’ Security Rules Enforcement

### **What Happens Behind the Scenes:**

1. **User tries to create a task:**
```javascript
await createTask(user.uid, { title: "Learn React" });
```

2. **Firestore receives the request:**
```
POST /databases/(default)/documents/tasks
Body: { user_id: "abc123", title: "Learn React" }
Auth: Bearer token from Firebase Auth
```

3. **Security rules validate:**
```javascript
// From firestore.rules
allow create: if isAuthenticated() && 
  request.resource.data.user_id == request.auth.uid;
```

4. **Validation checks:**
- âœ… Is user authenticated? â†’ YES
- âœ… Does `user_id` match `auth.uid`? â†’ YES
- âœ… Allow operation â†’ GRANTED

5. **If someone tries to access another user's data:**
```javascript
// Trying to read someone else's tasks
getTasks("different_user_id");
```
- âŒ Query returns empty (security rules filter it out)
- âŒ No error thrown, just no data returned
- âœ… Your data stays private

---

## ğŸ§ª Testing Your Setup

### **Test 1: Create Your First Task**

Run this in your code:

```typescript
import { createTask } from '@/lib/firebase/firestore';
import { useAuth } from '@/contexts/AuthContext';

const { user } = useAuth();

// Create a test task
const testTask = await createTask(user.uid, {
  title: "My first task in Firestore!",
  description: "Testing the integration",
  completed: false,
  estimatedMinutes: 15,
  priority: "medium"
});

console.log('Created task:', testTask);
```

### **Test 2: Verify in Firebase Console**

1. Go to Firebase Console â†’ Firestore Database
2. Look for `tasks` collection
3. You should see your new document
4. Verify `user_id` matches your Firebase Auth UID

### **Test 3: Load Tasks in UI**

Your Index.tsx already loads tasks:
```typescript
// This runs automatically when page loads
const [tasksData, streamsData] = await Promise.all([
  getTasks(user.uid),
  getStreams(user.uid)
]);
```

If you see tasks in the UI, it's working! âœ…

---

## ğŸš€ Next Steps

### **1. Deploy Your Security Rules** âš ï¸

Your rules are ready but need deployment:

```bash
firebase login
firebase deploy --only firestore:rules
```

Or via Firebase Console:
1. Go to Firestore Database â†’ Rules
2. Copy your `firestore.rules` content
3. Click Publish

### **2. Create Initial Data**

Choose one method:
- Wait for UI components to be built
- Add via Firebase Console (manual)
- Use browser console method (quick test)

### **3. Build UI for Data Input**

You'll need components like:
- TaskForm (create tasks)
- StreamForm (create learning streams)
- TaskList (display and manage tasks)

These will use your Firestore functions:
```typescript
import { 
  createTask, 
  getTasks, 
  updateTask, 
  deleteTask 
} from '@/lib/firebase/firestore';
```

---

## ğŸ“š Available Functions

### **Tasks:**
```typescript
createTask(userId, taskData)     // Create new task
getTasks(userId)                 // Get all user's tasks
updateTask(taskId, updates)      // Update task
deleteTask(taskId)               // Delete task
```

### **Streams:**
```typescript
createStream(userId, streamData) // Create new stream
getStreams(userId)               // Get all user's streams
updateStream(streamId, updates)  // Update stream
deleteStream(streamId)           // Delete stream
```

### **Audit Logs:**
```typescript
createAuditLog(logData)          // Log user action
getAuditLogs(userId?)            // Get logs (admin)
```

---

## âœ… Summary

**Your Firestore is ready!** Here's what you have:

âœ… **Schema defined** - Tasks, Streams, Focus Sessions, Audit Logs
âœ… **Security rules configured** - Production mode, user isolation
âœ… **Data flow established** - Auth â†’ Query â†’ Render
âœ… **API functions ready** - Create, Read, Update, Delete
âœ… **Type safety** - Full TypeScript support

**All you need to do:**
1. Deploy security rules (via Firebase Console or CLI)
2. Start inputting data (via UI, console, or Firebase Console)
3. Build more UI components as needed

Your ZURVAN app is **fully connected** to Firestore! ğŸ‰
